do ->

  TUMBLR_HOSTNAME       = 'www.tumblr.com'

  SELECTOR_POST_WRAPPER = '.post_wrapper'

  showKawpaaButton = (_$) ->
    hasPhoto = _$.find('.post_media_photo').length > 0
    existKawpaaButton = _$.find('.kawpaa-save-link').length isnt 0

    return if existKawpaaButton
    return unless hasPhoto

    html = """
      <div class="post_control post-control-icon icon-kawpaa kawpaa-save-link" title="Save to Kawpaa" data-subview="Save to Kawpaa" style="background-image: url(#{DATA_URL_GRAY_24});"></div>
    """
    _$.find('.post_controls_inner').append html

  sendBackground = (params) ->
    console.log params
    chrome.runtime.sendMessage params, (response) ->
      console.log response


  # Individual tweet page
  $(document).on
    'mouseenter': (e) -> showKawpaaButton($(this))
  , SELECTOR_POST_WRAPPER


  # Home timeline
  $(document).on
    'mouseenter': (e) -> showKawpaaButton($(this))
  , SELECTOR_POST_WRAPPER


  # Click
  $(document).on 'click', '.kawpaa-save-link', (e) ->
    e.preventDefault()

    # 画像の差し替え
    $(this).css('background-image', "url(#{DATA_URL_BLUE_24})")

    _targetElement = $(this).closest(SELECTOR_POST_WRAPPER)

    permalink = _targetElement.find('.post_permalink').attr('href')
    title = permalink
    imageUrl = _targetElement.find('.high_res_link').data('big-photo') or _targetElement.find('.post_media_photo').attr('src')

    params =
      name: TUMBLR_HOSTNAME
      info:
        siteUrl: permalink
        type: 'image'
        srcUrl: imageUrl
        title: title
    # TODO: linkにも対応。
    # info:
    #   url: "https://twitter.com#{tweetUrl}"
    #   type: 'link'
    #   siteImage: "#{imageUrl}:orig"
    sendBackground(params)




  DATA_URL_GRAY_24 = "data:image/png;base64,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"

  DATA_URL_BLUE_24 = "data:image/png;base64,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"
